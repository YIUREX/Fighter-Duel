<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fighter Duel ‚Äî PvP / IA</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#141a29; --panel2:#1b2235; --text:#e8eeff; --muted:#a8b0c9;
      --accent:#6ea8ff; --accent2:#8bffdf; --danger:#ff6b6b; --ok:#6bff95; --gold:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:radial-gradient(1200px 600px at 20% -10%,#1a2240 0%,transparent 50%),radial-gradient(1000px 800px at 120% 10%,#0f1630 0%,transparent 50%),var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:clamp(18px,2.8vw,28px);margin:0;font-weight:800;letter-spacing:0.3px}
    .chip{background:var(--panel2);color:var(--muted);padding:6px 10px;border-radius:999px;border:1px solid #253053}.panel{background:linear-gradient(180deg,var(--panel),#0f1526);border:1px solid #1f2742;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);padding:12px}
.setup{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
label{font-size:14px;color:var(--muted)}
select,button{appearance:none;border:1px solid #2a355f;background:linear-gradient(180deg,#1b2340,#151c34);color:var(--text);border-radius:12px;padding:10px 12px;font-weight:600}
button{cursor:pointer;transition:transform .06s ease, box-shadow .2s ease,border-color .2s ease}
button:hover{transform:translateY(-1px)}
button.primary{background:linear-gradient(180deg,#2c58ff,#1a38b8);border-color:#4b6dff;box-shadow:0 10px 18px rgba(76,108,255,.25)}
.small{padding:6px 10px;font-size:13px;border-radius:10px}

.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px}
.card{background:linear-gradient(180deg,#11182d,#0e1527);border:1px solid #223057;border-radius:14px;padding:10px;position:relative}
.card h3{margin:4px 0 6px;font-size:16px}
.pill{font-size:12px;color:var(--muted);border:1px solid #2b3a67;border-radius:999px;padding:2px 8px}
.stat{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);margin:4px 0}
.bar{height:6px;background:#121a31;border:1px solid #2a365a;border-radius:999px;overflow:hidden;flex:1}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}

/* Arena */
.arena{position:relative;height:360px;border-radius:18px;background:linear-gradient(180deg,#0d1230 0%,#0b0f1a 60%), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8"><path fill="%23141a29" d="M0,7 L7,0 L8,1 L1,8 Z"/></svg>');
  border:1px solid #1e2747;overflow:hidden}
.floor{position:absolute;left:0;right:0;bottom:0;height:80px;background:linear-gradient(180deg,#0f172e 0%,#0a0f1f 80%);border-top:1px solid #1c2547}
.line{position:absolute;left:0;right:0;bottom:80px;height:2px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent)}

.hud{position:absolute;left:0;right:0;top:8px;display:flex;justify-content:space-between;gap:10px;padding:0 10px;pointer-events:none}
.meter{min-width:240px;max-width:45%;display:grid;gap:6px}
.meter .name{font-weight:800;font-size:13px;color:#cfd6ff;text-shadow:0 0 8px rgba(110,168,255,.18)}
.hp, .energy{height:14px;border:1px solid #26315a;background:#0f1731;border-radius:10px;overflow:hidden}
.hp>i{display:block;height:100%;background:linear-gradient(90deg,#ff477e,#ffd166)}
.energy>i{display:block;height:100%;background:linear-gradient(90deg,#66ffd1,#66a6ff)}
.centerHUD{position:absolute;left:50%;transform:translateX(-50%);top:8px;text-align:center}
.timer{font-weight:900;font-size:28px;letter-spacing:1px;color:#dfe6ff;text-shadow:0 0 18px rgba(110,168,255,.25)}
.toast{position:absolute;left:50%;transform:translateX(-50%);top:44px;color:#a8b0c9;font-size:12px}

.fighter{position:absolute;bottom:80px;width:64px;height:96px;border-radius:10px;border:1px solid #26315a;background:linear-gradient(180deg,#2a3560,#121a33);display:flex;align-items:flex-end;justify-content:center;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.fighter .emoji{font-size:42px;filter:drop-shadow(0 3px 3px rgba(0,0,0,.35));margin-bottom:4px}
.fighter.p1{outline:2px solid rgba(110,168,255,.35)}
.fighter.p2{outline:2px solid rgba(255,107,107,.35)}
.hitbox{position:absolute;border:1px dashed rgba(255,255,255,.12);pointer-events:none}

.projectile{position:absolute;width:22px;height:12px;border-radius:999px;background:radial-gradient(circle at 30% 50%, #fff, #8bf, #49f);box-shadow:0 0 14px #7cf}
.fx{position:absolute;pointer-events:none;mix-blend-mode:screen}

.controls{display:flex;gap:8px;flex-wrap:wrap}
.kbd{border:1px solid #2a355f;background:#121a2b;border-radius:8px;padding:2px 6px;font-size:12px;color:#cdd5ff}

/* Touch controls */
.touch{display:none;position:relative;gap:10px;justify-content:space-between;margin-top:8px}
.pad{display:flex;gap:8px}
.btn{width:64px;height:64px;border-radius:16px;border:1px solid #2a355f;background:linear-gradient(180deg,#1b2340,#151c34);display:flex;align-items:center;justify-content:center;font-weight:900}
.btn:active{transform:scale(.98)}
.btn.small{width:54px;height:54px}

@media (max-width:900px){
  .setup{grid-template-columns:1fr}
  .meter{min-width:unset;max-width:48%}
  .touch{display:flex}
}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Fighter Duel <span class="chip">PvP o contra IA</span></h1>
      <div class="controls">
        <span class="chip">Hecho para GitHub Pages ¬∑ 1 archivo</span>
      </div>
    </header><section class="panel setup" id="setup">
  <div>
    <div class="row" style="justify-content:space-between;align-items:end">
      <div class="row">
        <label>Modo:</label>
        <select id="mode">
          <option value="p1-vs-ai">Jugador 1 vs IA</option>
          <option value="p1-vs-p2">Jugador 1 vs Jugador 2</option>
        </select>
      </div>
      <button id="start" class="primary">Iniciar Combate</button>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="controls" style="flex:1">
        <div>
          <div class="pill">Jugador 1</div>
          <div class="controls" style="margin-top:6px">
            <span class="kbd">A / D</span> mover
            <span class="kbd">S</span> bloquear
            <span class="kbd">J</span> ataque
            <span class="kbd">K</span> habilidad
          </div>
        </div>
        <div>
          <div class="pill">Jugador 2</div>
          <div class="controls" style="margin-top:6px">
            <span class="kbd">‚óÄÔ∏é / ‚ñ∂Ô∏é</span> mover
            <span class="kbd">‚ñº</span> bloquear
            <span class="kbd">/</span> ataque
            <span class="kbd">.</span> habilidad
          </div>
        </div>
      </div>
    </div>

    <div class="touch" id="touch">
      <div class="pad">
        <button class="btn" data-btn="left">‚óÄÔ∏é</button>
        <button class="btn" data-btn="right">‚ñ∂Ô∏é</button>
        <button class="btn small" data-btn="block">üõ°Ô∏è</button>
      </div>
      <div class="pad">
        <button class="btn" data-btn="attack">‚öîÔ∏è</button>
        <button class="btn" data-btn="special">‚ú®</button>
      </div>
    </div>
  </div>

  <div>
    <div class="row" style="justify-content:space-between">
      <div class="pill">Elige luchadores</div>
      <button id="random" class="small">Aleatorio</button>
    </div>
    <div class="cards" id="cards"></div>
  </div>
</section>

<section class="panel arena" id="arena" aria-label="Arena de combate" hidden>
  <div class="line"></div>
  <div class="floor"></div>
  <div class="hud">
    <div class="meter" id="hud1">
      <div class="name">P1 ‚Äî <span data-field="name">?</span></div>
      <div class="hp"><i style="width:100%"></i></div>
      <div class="energy"><i style="width:0%"></i></div>
    </div>
    <div class="centerHUD">
      <div class="timer" id="timer">90</div>
      <div class="toast" id="toast"></div>
    </div>
    <div class="meter" id="hud2" style="text-align:right">
      <div class="name">P2 ‚Äî <span data-field="name">?</span></div>
      <div class="hp"><i style="width:100%"></i></div>
      <div class="energy"><i style="width:0%"></i></div>
    </div>
  </div>
  <!-- Fighters injected here -->
</section>

<section class="panel" id="after" hidden>
  <div class="row" style="justify-content:space-between;align-items:center">
    <div class="controls">
      <strong id="result">Resultado</strong>
      <span id="stats" class="chip"></span>
    </div>
    <div class="row">
      <button id="rematch">Revancha</button>
      <button id="back">Volver a selecci√≥n</button>
    </div>
  </div>
</section>

<footer class="row" style="justify-content:space-between;color:var(--muted);font-size:12px">
  <div>Controles t√°ctiles aparecen en pantallas peque√±as (solo P1 vs IA).</div>
  <div>üí° Sugerencias de mejora: combos, saltos, online, skins‚Ä¶</div>
</footer>

  </div>  <script>
  // ====== Datos de luchadores ======
  const FIGHTERS = [
    {
      id:'blaze', name:'Blaze', emoji:'üî•', hp:120, speed:2.2, power:11, defense:0.9,
      desc:'R√°pido, proyectil de fuego.',
      special:{name:'Bola de Fuego', cost:50, cd:5, exec: specialFireball}
    },
    {
      id:'titan', name:'Titan', emoji:'üõ†Ô∏è', hp:160, speed:1.7, power:14, defense:0.85,
      desc:'Tanque, golpe s√≠smico que aturde.',
      special:{name:'Golpe S√≠smico', cost:50, cd:7, exec: specialSlam}
    },
    {
      id:'shade', name:'Shade', emoji:'üó°Ô∏è', hp:110, speed:2.6, power:10, defense:1.0,
      desc:'√Ågil, dash atravesando al rival.',
      special:{name:'Sombras', cost:50, cd:6, exec: specialDash}
    },
    {
      id:'nova', name:'Nova', emoji:'‚ö°', hp:130, speed:2.0, power:12, defense:0.95,
      desc:'Rayo dirigido con retardo.',
      special:{name:'Llamado del Rayo', cost:50, cd:6, exec: specialStrike}
    },
  ];

  // ====== Estado global ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const state = {
    running:false, mode:'p1-vs-ai',
    p1:null, p2:null, 
    lastTime:0, timer:90, toastTimer:0,
    keys:new Set(),
    projectiles:[], effects:[],
  };

  // ====== Utilidades ======
  function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
  function rectsOverlap(a,b){return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom)}
  function centerX(el){return el.offsetLeft + el.offsetWidth/2}
  function showToast(msg){ const t=$('#toast'); t.textContent=msg; state.toastTimer=1.5; }

  function createCard(f){
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>${f.emoji} ${f.name}</h3>
        <span class="pill">${f.special.name}</span>
      </div>
      <div class="stat">Vida <div class="bar"><i style="width:${Math.round(f.hp/1.8)}%"></i></div></div>
      <div class="stat">Velocidad <div class="bar"><i style="width:${Math.round(f.speed/3*100)}%"></i></div></div>
      <div class="stat">Ataque <div class="bar"><i style="width:${Math.round(f.power/16*100)}%"></i></div></div>
      <div class="stat">Defensa <div class="bar"><i style="width:${Math.round(f.defense*100)}%"></i></div></div>
      <div class="row" style="margin-top:8px;justify-content:space-between">
        <button class="small" data-pick="p1">Elegir P1</button>
        <button class="small" data-pick="p2">Elegir P2</button>
      </div>
    `;
    el.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const who = btn.getAttribute('data-pick');
        selectFighter(who,f);
      });
    });
    return el;
  }

  function renderCards(){
    const wrap = $('#cards'); wrap.innerHTML='';
    FIGHTERS.forEach(f=> wrap.appendChild(createCard(f)) );
  }

  function selectFighter(who,f){
    const hud = who==='p1' ? $('#hud1') : $('#hud2');
    hud.querySelector('[data-field="name"]').textContent = `${f.name}`;
    hud.dataset.fid = f.id;
  }

  function randomPick(){
    const r1 = FIGHTERS[Math.floor(Math.random()*FIGHTERS.length)];
    let r2 = FIGHTERS[Math.floor(Math.random()*FIGHTERS.length)];
    if(r2.id===r1.id) r2 = FIGHTERS[(FIGHTERS.indexOf(r2)+1)%FIGHTERS.length];
    selectFighter('p1', r1); selectFighter('p2', r2);
  }

  // ====== Entidad Luchador ======
  function makeFighter(f, side){
    const arena = $('#arena');
    const el = document.createElement('div'); el.className = `fighter ${side}`;
    el.innerHTML = `<div class="emoji">${f.emoji}</div>`;
    arena.appendChild(el);
    const x = side==='p1' ? 80 : arena.clientWidth-144;
    const obj = {
      side, el,
      name:f.name, emoji:f.emoji,
      maxHp:f.hp, hp:f.hp,
      energy:0,
      speed:f.speed, power:f.power, defense:f.defense,
      special:f.special,
      x, y:0, w:64, h:96, facing: side==='p1' ? 1 : -1,
      attackCooldown:0, specialCooldown:0, block:false, stun:0,
      ai: (state.mode==='p1-vs-ai' && side==='p2') ? makeAIController() : null,
    };
    return obj;
  }

  function updateHUD(){
    const a = state.p1, b = state.p2;
    const h1 = $('#hud1 .hp i'), h2 = $('#hud2 .hp i');
    const e1 = $('#hud1 .energy i'), e2 = $('#hud2 .energy i');
    h1.style.width = clamp(a.hp/a.maxHp*100,0,100)+"%";
    h2.style.width = clamp(b.hp/b.maxHp*100,0,100)+"%";
    e1.style.width = clamp(a.energy,0,100)+"%";
    e2.style.width = clamp(b.energy,0,100)+"%";
  }

  // ====== Acciones ======
  function tryAttack(p, target){
    if(p.attackCooldown>0 || p.stun>0) return;
    p.attackCooldown = 0.7; // segundos
    // Hitbox delante del jugador
    const range = 78; const hb = {left:p.x + (p.facing>0? p.w : -range), top: p.el.offsetTop, right: p.x + (p.facing>0? p.w+range : 0), bottom: p.el.offsetTop + p.h};
    const ob = {left:target.x, top: target.el.offsetTop, right: target.x+target.w, bottom: target.el.offsetTop+target.h};
    flashFX(p, 'slash');
    if(rectsOverlap(hb, ob)){
      let dmg = p.power;
      if(target.block && target.facing===-p.facing){ dmg*=0.35; gainEnergy(target, 6); } // bloqueo efectivo
      dealDamage(target, dmg);
      gainEnergy(p, 10);
      // peque√±o empuje
      target.x += 12 * p.facing;
    }
  }

  function dealDamage(target, amount){
    const dmg = Math.round(amount * target.defense);
    target.hp = clamp(target.hp - dmg, 0, target.maxHp);
    shake(target);
  }

  function gainEnergy(p, v){ p.energy = clamp(p.energy + v, 0, 100); }

  function tryBlock(p, on){ if(p.stun>0) {p.block=false; return;} p.block=on; }

  function trySpecial(p, target){
    if(p.specialCooldown>0 || p.stun>0) return;
    if(p.energy < p.special.cost) { showToast('No hay energ√≠a suficiente'); return; }
    p.energy -= p.special.cost; p.specialCooldown = p.special.cd; p.special.exec(p, target);
  }

  function flashFX(p, type){
    const fx = document.createElement('div'); fx.className='fx';
    if(type==='slash'){
      fx.style.width='70px'; fx.style.height='60px'; fx.style.left=(p.facing>0? p.x+p.w-10 : p.x-60)+'px'; fx.style.bottom='120px';
      fx.style.background='radial-gradient(circle at 50% 50%, rgba(255,255,255,.9), rgba(255,200,200,.3), transparent 60%)';
    }
    if(type==='stun'){
      fx.textContent='‚ú∑'; fx.style.fontSize='28px'; fx.style.left=(p.x+p.w/2)+'px'; fx.style.bottom='170px';
    }
    $('#arena').appendChild(fx);
    setTimeout(()=>fx.remove(), 260);
  }

  // ====== Specials ======
  function specialFireball(p, target){
    const proj = {el: document.createElement('div'), x: p.x + (p.facing>0? p.w: -22), y: $('#arena').clientHeight - 80 - 54, v: 4.2 * p.facing, owner:p, dmg:12};
    proj.el.className='projectile'; proj.el.style.bottom=proj.y+'px';
    $('#arena').appendChild(proj.el); state.projectiles.push(proj);
  }
  function specialSlam(p, target){
    flashFX(p,'stun');
    const hb = {left:p.x - 20, right:p.x + p.w + 20, top: p.el.offsetTop, bottom: p.el.offsetTop + p.h};
    const ob = {left:target.x, right:target.x+target.w, top: target.el.offsetTop, bottom: target.el.offsetTop+target.h};
    if(rectsOverlap(hb,ob)){
      dealDamage(target, p.power*1.7);
      target.stun = 1.2;
    }
  }
  function specialDash(p, target){
    const dist = 120 * p.facing; p.x = clamp(p.x + dist, 0, $('#arena').clientWidth - p.w);
    const hb = {left:p.x, right:p.x+p.w, top:p.el.offsetTop, bottom:p.el.offsetTop+p.h};
    const ob = {left:target.x, right:target.x+target.w, top: target.el.offsetTop, bottom: target.el.offsetTop+target.h};
    if(rectsOverlap(hb,ob)) dealDamage(target, p.power*1.2);
  }
  function specialStrike(p, target){
    // rayo tras breve retardo sobre la cabeza del rival
    const mark = document.createElement('div'); mark.className='fx'; mark.textContent='‚ö°'; mark.style.fontSize='36px'; mark.style.left=(target.x+target.w/2)+'px'; mark.style.bottom='200px';
    $('#arena').appendChild(mark);
    setTimeout(()=>{ dealDamage(target, p.power*1.5); mark.remove(); }, 420);
  }

  // ====== IA simple ======
  function makeAIController(){
    return { think(dt, me, foe){
      if(me.stun>0) return;
      const dist = (foe.x+foe.w/2) - (me.x+me.w/2);
      me.facing = dist>0 ? 1 : -1;
      // Moverse para acercarse
      if(Math.abs(dist) > 120){ me.x += Math.sign(dist) * me.speed*40*dt; me.block=false; }
      else {
        // En rango de ataque
        if(me.attackCooldown<=0 && Math.random()<0.5) tryAttack(me,foe);
        // Usar especial si hay energ√≠a y de vez en cuando
        if(me.specialCooldown<=0 && me.energy>=me.special.cost && Math.random()<0.3) trySpecial(me,foe);
        // A veces bloquear
        if(Math.random()<0.15) me.block=true; else me.block=false;
      }
    }}
  }

  function shake(p){ p.el.animate([{transform:'translate(0,0)'},{transform:'translate(4px,0)'},{transform:'translate(0,0)'}],{duration:120}); }

  // ====== Bucle principal ======
  function gameLoop(ts){
    if(!state.running) return;
    const dt = Math.min(0.033, (ts - state.lastTime)/1000 || 0.016); state.lastTime = ts;
    const arenaW = $('#arena').clientWidth;
    const a = state.p1, b = state.p2;

    // Input P1
    if(a.stun<=0){
      if(state.keys.has('a')) { a.x -= a.speed*60*dt; a.facing=-1; }
      if(state.keys.has('d')) { a.x += a.speed*60*dt; a.facing=1; }
    }
    tryBlock(a, state.keys.has('s'));

    // Input P2 (si no IA)
    if(!b.ai && b.stun<=0){
      if(state.keys.has('arrowleft')) { b.x -= b.speed*60*dt; b.facing=-1; }
      if(state.keys.has('arrowright')) { b.x += b.speed*60*dt; b.facing=1; }
    }
    tryBlock(b, !b.ai && state.keys.has('arrowdown'));

    // IA pensar
    if(b.ai) b.ai.think(dt, b, a);

    // Enfriamientos y estados
    [a,b].forEach(p=>{
      p.attackCooldown=Math.max(0,p.attackCooldown-dt);
      p.specialCooldown=Math.max(0,p.specialCooldown-dt);
      p.stun=Math.max(0,p.stun-dt);
      // Evitar superposici√≥n total: empuje suave
      const minX = 0, maxX = arenaW - p.w; p.x = clamp(p.x, minX, maxX);
      p.el.style.left = p.x + 'px';
      p.el.style.transform = `scaleX(${p.facing})`;
    });

    // Proyectiles
    state.projectiles.forEach((prj,idx)=>{
      prj.x += prj.v;
      prj.el.style.left = prj.x + 'px'; prj.el.style.bottom = prj.y + 'px';
      const target = prj.owner===a ? b : a;
      const hb = {left:prj.x, right:prj.x+22, top: prj.y, bottom: prj.y+12};
      const ob = {left:target.x, right:target.x+target.w, top: target.el.offsetTop, bottom: target.el.offsetTop+target.h};
      if(rectsOverlap(hb,ob)){
        let dmg = prj.dmg; if(target.block && target.facing===-prj.owner.facing) dmg*=0.4;
        dealDamage(target, dmg); gainEnergy(prj.owner, 12);
        prj.el.remove(); state.projectiles.splice(idx,1);
      }
      // Fuera de arena
      if(prj.x < -40 || prj.x > arenaW+40){ prj.el.remove(); state.projectiles.splice(idx,1); }
    });

    // Temporizador & fin de ronda
    state.timer -= dt; if(state.timer<0) state.timer=0;
    $('#timer').textContent = Math.ceil(state.timer);
    if(state.toastTimer>0){ state.toastTimer -= dt; if(state.toastTimer<=0) $('#toast').textContent=''; }

    updateHUD();

    if(a.hp<=0 || b.hp<=0 || state.timer<=0){
      endRound(); return;
    }

    requestAnimationFrame(gameLoop);
  }

  function endRound(){
    state.running=false;
    const a = state.p1, b = state.p2;
    const res = a.hp===b.hp ? 'Empate' : (a.hp>b.hp ? '¬°Victoria P1!' : '¬°Victoria P2!');
    $('#result').textContent = res;
    $('#stats').textContent = `P1 ${Math.max(0,Math.round(a.hp))} HP ¬∑ P2 ${Math.max(0,Math.round(b.hp))} HP`;
    $('#after').hidden=false; $('#arena').hidden=true; window.scrollTo({top:0,behavior:'smooth'});
  }

  // ====== Controles ======
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    state.keys.add(k);
    // Acciones instant√°neas
    if(k==='j') tryAttack(state.p1, state.p2);
    if(k==='k') trySpecial(state.p1, state.p2);
    if(!state.p2.ai){
      if(k==='/') tryAttack(state.p2, state.p1);
      if(k==='.') trySpecial(state.p2, state.p1);
    }
  });
  window.addEventListener('keyup', (e)=>{ state.keys.delete(e.key.toLowerCase()); });

  // Touch (solo P1)
  const touchBtns = {left:false,right:false,block:false};
  function bindTouch(btn, key){
    const el = document.querySelector(`[data-btn="${btn}"]`);
    const on = ()=>{ touchBtns[btn]=true; if(btn==='attack') tryAttack(state.p1,state.p2); if(btn==='special') trySpecial(state.p1,state.p2); };
    const off = ()=>{ touchBtns[btn]=false; };
    el.addEventListener('touchstart', (e)=>{e.preventDefault(); on();});
    el.addEventListener('touchend', (e)=>{e.preventDefault(); off();});
    el.addEventListener('mousedown', (e)=>{e.preventDefault(); on();});
    el.addEventListener('mouseup', (e)=>{e.preventDefault(); off();});
  }
  ['left','right','block','attack','special'].forEach(b=> bindTouch(b));

  // Aplicar input t√°ctil a P1 en cada frame
  const applyTouch = ()=>{
    if(!state.running) return;
    if(state.mode==='p1-vs-ai'){
      if(touchBtns.left){ state.p1.x -= state.p1.speed*2.2; state.p1.facing=-1; }
      if(touchBtns.right){ state.p1.x += state.p1.speed*2.2; state.p1.facing=1; }
      tryBlock(state.p1, !!touchBtns.block);
    }
    requestAnimationFrame(applyTouch);
  };

  // ====== Inicio / Reset ======
  function startFight(){
    const mode = $('#mode').value; state.mode = mode;
    const id1 = $('#hud1').dataset.fid || 'blaze';
    const id2 = $('#hud2').dataset.fid || (mode==='p1-vs-ai' ? 'titan' : 'shade');
    const f1 = FIGHTERS.find(f=>f.id===id1); const f2 = FIGHTERS.find(f=>f.id===id2);

    // Preparar arena
    const arena = $('#arena'); arena.querySelectorAll('.fighter,.projectile,.fx').forEach(n=>n.remove());
    $('#setup').hidden=true; $('#after').hidden=true; arena.hidden=false;

    state.p1 = makeFighter(f1,'p1');
    state.p2 = makeFighter(f2,'p2');

    $('#hud1 [data-field="name"]').textContent=f1.name; $('#hud2 [data-field="name"]').textContent=f2.name;

    state.timer = 90; state.lastTime=0; state.running=true; state.projectiles=[]; state.effects=[];

    // Mostrar/ocultar controles t√°ctiles
    $('#touch').style.display = (window.innerWidth<900 && mode==='p1-vs-ai') ? 'flex' : 'none';

    requestAnimationFrame(gameLoop);
    requestAnimationFrame(applyTouch);
  }

  // Eventos UI
  $('#start').addEventListener('click', startFight);
  $('#rematch').addEventListener('click', startFight);
  $('#back').addEventListener('click', ()=>{ $('#setup').hidden=false; $('#after').hidden=true; $('#arena').hidden=true; });
  $('#random').addEventListener('click', randomPick);
  $('#mode').addEventListener('change', (e)=>{
    const isAI = e.target.value==='p1-vs-ai';
    $('#touch').style.display = (window.innerWidth<900 && isAI) ? 'flex' : 'none';
  });

  // Inicializar
  renderCards(); randomPick();
  </script></body>
</html>
